# 讯极日历 (SynJi AI Calendar) 全面接口技术文档 (v1.9 - Final)

> **版本更新说明 (v1.9)**: 
> 1. **管理权限下放**：允许 **群主 (OWNER)** 和 **管理员 (ADMIN)** 查看群成员列表。
> 2. **成员列表规范**：规定列表需按昵称首字母进行字母表排序（建议后端 SQL 直接排序）。
> 3. **详情穿透**：明确点击成员项可查看个人资料详情，非管理层禁止进入成员管理界面。
> 4. **后台安全性增强**：**后端必须** 在 API 层面对管理员限额（最多2人）和操作权限（日程修改/删除）进行拦截。

---

## 1. 基础约定

### 1.1 服务地址
- **局域网调试地址**: `http://192.168.43.227:8080`
- **模拟器访问地址**: `http://10.0.2.2:8080`

### 1.2 通用响应格式 (ApiResponse)
```json
{
  "code": 200,       // 200-成功，400-参数错误，401-未授权，403-无权操作，500-服务器异常
  "message": "success", 
  "data": null       // 业务数据
}
```

---

## 2. 认证与用户模块 (Auth & User)

### 2.1 发送验证码 & 登录
- **发码**: `POST /api/auth/send-code` -> `{ "phoneNumber": "..." }`
- **登录**: `POST /api/auth/login` -> 返回 `token` 和 `user` 对象。

### 2.2 用户资料
- **获取**: `GET /api/user/info`
- **更新**: `PUT /api/user/update` -> `{ "nickname": "..." }`

---

## 3. 群组功能 (Group) - **管理权限与安全约束**

### 3.1 基础功能
- **获取已加入群组**: `GET /api/group/list`
- **创建群组**: `POST /api/group/create`
- **加入群组**: `POST /api/group/join` (通过 `inviteCode`)

### 3.2 群成员管理 (v1.9 强化)
- **获取成员列表**:
  - **路径**: `/api/group/members`
  - **方法**: `GET`
  - **参数**: `groupId` (Query String)
  - **后端校验**: **必须校验** 请求者角色。若非该群 OWNER 或 ADMIN，应返回 `403 Forbidden`。
  - **排序规则**: 后端 SQL 需使用 `ORDER BY nickname ASC`。
  - **响应数据**:
    ```json
    [
      {
        "userId": "10001",
        "nickname": "张三",
        "phoneNumber": "13800138000",
        "role": "OWNER", // OWNER, ADMIN, MEMBER
        "joinedAt": "2024-05-20 10:00:00"
      }
    ]
    ```

- **角色晋升/降级 (管理员设置)**:
  - **路径**: `/api/group/set-admin`
  - **方法**: `POST`
  - **请求体**: `{ "groupId": "10", "userId": "10002", "isAdmin": true }`
  - **后端核心约束 (必做)**: 
    1. **权限判定**: 仅允许 `OWNER` 执行此操作。
    2. **名额判定**: 当 `isAdmin` 为 `true` 时，后端必须先查询当前群组 `role='ADMIN'` 的记录数。**若已达 2 人，必须拒绝请求**并返回 `400 (管理员名额已满)`。

---

## 4. 日程管理模块 (Schedule) - **读写权限校验**

### 4.1 获取日程列表
- **路径**: `/api/schedule/list`
- **并集查询**: 返回 `belonging = "个人"` (创建者) OR `belonging IN (用户所属群组名称)` 的记录。

### 4.2 更新/删除日程 (安全性关键)
- **后端校验逻辑**:
  - **个人日程**: 仅限 `userId == creatorId`。
  - **群组日程**: 仅限该群组的 `OWNER` 或 `ADMIN` 有权执行 `PUT` 或 `DELETE`。
  - **普通成员 (MEMBER)**: 仅能通过 `GET` 查看，后端必须拦截其 `PUT/DELETE` 请求。

### 4.3 状态同步 (红点逻辑)
- **标记已读**: `POST /api/schedule/viewed` -> `{ "scheduleId": "..." }`
- **说明**: 当用户进入详情页时，前端调用此接口，后端将 `is_viewed` 置为 `1`。

---

## 5. 核心逻辑总结 (发给后端参考)

### 5.1 数据库映射
| 逻辑字段 | 数据库列名 | 说明 |
| :--- | :--- | :--- |
| role | role | OWNER(1人), ADMIN(最多2人), MEMBER |
| is_viewed | is_viewed | 0-未读(APP显红点), 1-已读 |
| is_ai_generated | is_ai_generated | 1-AI识别产生的日程 |

### 5.2 后端三大安全防线
1. **防止横向越权**: 禁止普通成员通过 API 修改群组公共日程。
2. **严控管理员名额**: 后端数据库层面硬拦截“第3个管理员”的产生。
3. **数据隔离**: 获取成员列表接口必须有严格的权限身份过滤，防止敏感信息（如手机号）泄露给普通成员。
